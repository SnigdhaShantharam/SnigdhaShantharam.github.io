{# Jekyll layout that compresses HTML #}
{# v3.0.2 #}
{# MIT License #}

{% set LINE_FEED = "" %}

{% if environment not in site.compress_html.ignore.envs %}
  {% set _content = content %}
  {% set _profile = site.compress_html.profile %}

  {% if site.compress_html.endings == "all" %}
    {% set _endings = "html head body li dt dd p rt rp optgroup option colgroup caption thead tbody tfoot tr td th" | split(" ") %}
  {% else %}
    {% set _endings = site.compress_html.endings %}
  {% endif %}

  {% for _element in _endings %}
    {% set _end = "</" + _element + ">" %}
    {% set _content = _content | replace(_end, "") %}
  {% endfor %}

  {% if _profile and _endings %}
    {% set _profile_endings = _content | length + 1 %}
  {% endif %}

  {% for _element in site.compress_html.startings %}
    {% set _start = "<" + _element + ">" %}
    {% set _content = _content | replace(_start, "") %}
  {% endfor %}

  {% if _profile and site.compress_html.startings %}
    {% set _profile_startings = _content | length + 1 %}
  {% endif %}

  {% if site.compress_html.comments == "all" %}
    {% set _comments = ["<!-- -->"] %}
  {% else %}
    {% set _comments = site.compress_html.comments %}
  {% endif %}

  {% if _comments | length == 2 %}
    {% set _content = _content | replace(_comments[0], "") %}
  {% endif %}

  {% set _pre_befores = _content | split("<pre") %}
  {% set _content = "" %}

  {% for _pre_before in _pre_befores %}
    {% set _pres = _pre_before | split("</pre>") %}
    {% set _pres_after = "" %}

    {% if _pres | length != 0 %}
      {% if site.compress_html.blanklines %}
        {% set _lines = _pres[-1] | split(LINE_FEED) %}
        {% for _line in _lines %}
          {% set _trimmed = _line | split(" ") | join(" ") %}
          {% if _trimmed != "" or loop.last %}
            {% if not loop.first %}{{ LINE_FEED }}{% endif %}
            {{ _line }}
          {% endif %}
        {% endfor %}
      {% else %}
        {% set _pres_after = _pres[-1] | split(" ") | join(" ") %}
      {% endif %}
    {% endif %}

    {% set _content = _content + (_pre_before | split("</pre>")) %}
  {% endfor %}

  {% set _clippings = site.compress_html.clippings | default("html head title base link meta style body article section nav aside h1 h2 h3 h4 h5 h6 hgroup header footer address p hr blockquote ol ul li dl dt dd figure figcaption main div table caption colgroup col tbody thead tfoot tr td th") | split(" ") %}
  {% for _element in _clippings %}
    {% set _edges = ['<' + _element + '>', '</' + _element + '>'] %}
    {% set _content = _content | replace(_edges[0], "") | replace(_edges[1], "") %}
  {% endfor %}

  {{ _content }}

  {% if _profile %}
    <table id="compress_html_profile_{{ site.time | date('%Y%m%d') }}" class="compress_html_profile">
      <thead>
        <tr>
          <td>Step</td>
          <td>Bytes</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>raw</td>
          <td>{{ content | length }}</td>
        </tr>
        {% if _profile_endings %}
          <tr>
            <td>endings</td>
            <td>{{ _profile_endings }}</td>
          </tr>
        {% endif %}
        {% if _profile_startings %}
          <tr>
            <td>startings</td>
            <td>{{ _profile_startings }}</td>
          </tr>
        {% endif %}
        {% if _profile_comments %}
          <tr>
            <td>comments</td>
            <td>{{ _profile_comments }}</td>
          </tr>
        {% endif %}
        {% if _profile_collapse %}
          <tr>
            <td>collapse</td>
            <td>{{ _profile_collapse }}</td>
          </tr>
        {% endif %}
        {% if _profile_clippings %}
          <tr>
            <td>clippings</td>
            <td>{{ _profile_clippings }}</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  {% endif %}
{% else %}
  {{ content }}
{% endif %}
